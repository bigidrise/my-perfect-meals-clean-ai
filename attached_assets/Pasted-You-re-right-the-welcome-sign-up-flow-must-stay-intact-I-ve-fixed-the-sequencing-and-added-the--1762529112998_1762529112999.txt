You’re right — the welcome/sign-up flow must stay intact. I’ve fixed the sequencing and added the **Lifestyle Guided Tour**. Below are drop-in changes (no guessing, no questions).

---

# 1) Restore the proper flow (Auth → Welcome → Gate → Home)

### Update `client/src/components/AppRouter.tsx`

This enforces:

* Not signed in → `/auth`
* First login → `/welcome` (your existing Welcome.tsx)
* After Welcome → **WelcomeGate** (choose Coach/Self)
* Then → `/dashboard`

```tsx
import { useEffect, useState } from "react";
import WelcomeGate from "./WelcomeGate";
import { useLocation } from "wouter";
// If you have an auth hook, use it; otherwise preserve your existing logic:
import { useAuth } from "@/providers/AuthProvider"; // adjust import if needed

const get = (k: string) => localStorage.getItem(k);
const set = (k: string, v: string) => localStorage.setItem(k, v);

export default function AppRouter({ children }) {
  const { user, loading } = useAuth();          // user === null when signed out
  const [location, setLocation] = useLocation();
  const [showGate, setShowGate] = useState(false);

  const hasSeenWelcome = get("mpm.hasSeenWelcome") === "true";
  const coachMode = get("coachMode"); // "guided" | "self" | null

  useEffect(() => {
    if (loading) return;

    // Always normalize root
    if (location === "/") {
      if (!user) {
        setLocation("/auth");
        return;
      }
      if (!hasSeenWelcome) {
        setLocation("/welcome");
        return;
      }
      if (!coachMode) {
        // show gate *before* home
        setShowGate(true);
        return;
      }
      setLocation("/dashboard");
      return;
    }

    // If user is not signed in, force to /auth
    if (!user && location !== "/auth") {
      setLocation("/auth");
      return;
    }

    // If user is signed in and on /welcome but they've already seen it, skip
    if (user && location === "/welcome" && hasSeenWelcome) {
      if (!coachMode) {
        setShowGate(true);
        return;
      }
      setLocation("/dashboard");
    }
  }, [location, user, loading, hasSeenWelcome, coachMode, setLocation]);

  if (showGate) {
    return (
      <WelcomeGate
        onComplete={() => {
          setShowGate(false);
          setLocation("/dashboard");
        }}
      />
    );
  }

  return <>{children}</>;
}
```

### Minimal tweak in `client/src/pages/Welcome.tsx`

Add a “Continue” that marks the welcome as seen and advances (this preserves your welcome page).

```tsx
import { useLocation } from "wouter";

export default function Welcome() {
  const [, setLocation] = useLocation();
  const continueToGate = () => {
    localStorage.setItem("mpm.hasSeenWelcome", "true");
    // AppRouter will display WelcomeGate next
    setLocation("/");
  };

  return (
    <div className="p-6 text-white">
      {/* your existing welcome UI */}
      <h1 className="text-3xl font-bold">Welcome to My Perfect Meals</h1>
      <p className="text-white/80 mt-2">Powered by Emotion AI</p>

      <button
        onClick={continueToGate}
        className="mt-6 px-5 py-3 rounded-xl bg-white/10 hover:bg-white/20 border border-white/20"
      >
        Continue
      </button>
    </div>
  );
}
```

> Result: **Sign Up / Auth** → **Welcome.tsx** → **WelcomeGate (Coach/Self)** → **Dashboard** → guided flows you already added.

---

# 2) Lifestyle Guided Tour (Start-Here flash → all options pulse)

Create: `client/src/components/guided/LifestyleGuidedTour.tsx`

```tsx
import { useState } from "react";

export default function LifestyleGuidedTour() {
  const coachMode = localStorage.getItem("coachMode") === "guided";
  const [open, setOpen] = useState(false);

  if (!coachMode) return null;

  return (
    <>
      {/* Flashing START HERE button */}
      {!open && (
        <button
          onClick={() => setOpen(true)}
          className="fixed top-4 left-1/2 -translate-x-1/2 z-[60] px-4 py-2 rounded-xl text-white font-medium bg-emerald-600/90 border border-emerald-300/40 backdrop-blur flash-green"
        >
          Start here
        </button>
      )}

      {open && <LifestyleOverlay onClose={() => setOpen(false)} />}
    </>
  );
}

function LifestyleOverlay({ onClose }: { onClose: () => void }) {
  const items = [
    { key: "craving", label: "Craving Creator", desc: "Tell us what you crave; get a healthy version." },
    { key: "fridge", label: "Fridge Rescue", desc: "Pick what you have; we build meals from it." },
    { key: "restaurants", label: "Restaurant Guide", desc: "Find meals you can order out, aligned to your macros." },
    { key: "kids", label: "Healthy Kids Meals", desc: "Quick, kid-friendly healthy options." },
    { key: "alcohol", label: "Alcohol Hub", desc: "Smart choices for drinks & pairings." },
  ];

  return (
    <div className="fixed inset-0 z-[70] bg-black/80 backdrop-blur-md flex items-center justify-center">
      <div className="bg-black/50 border border-white/15 text-white rounded-3xl shadow-xl p-6 max-w-lg w-[92vw] relative">
        <h2 className="text-2xl font-bold mb-2">Lifestyle Hub</h2>
        <p className="text-white/80 text-sm mb-6">
          Pick a feature to begin. All buttons below are interactive — tap one to proceed.
        </p>

        <div className="space-y-3">
          {items.map((it) => (
            <button
              key={it.key}
              onClick={() => {
                // Simulate clicking real tile by data attribute if present:
                const el = document.querySelector(
                  `[data-lifestyle="${it.key}"]`
                ) as HTMLElement | null;
                if (el) el.click();
                else {
                  // Fallback by route if you prefer:
                  // location.href = "/craving-creator"; etc. (or use wouter in-page)
                }
                onClose();
              }}
              className="w-full p-4 text-left rounded-xl border border-white/20 bg-white/10 hover:bg-white/20 transition-all flash-white"
            >
              <p className="font-semibold">{it.label}</p>
              <p className="text-white/70 text-sm">{it.desc}</p>
            </button>
          ))}
        </div>

        <button
          onClick={onClose}
          className="absolute top-3 right-3 text-white/60 hover:text-white text-xl"
        >
          ✕
        </button>
      </div>
    </div>
  );
}
```

**CSS:** you already added `.flash-green` and `.flash-white`.

### Integrate into `client/src/pages/EmotionAIHub.tsx` (Lifestyle hub)

```tsx
import LifestyleGuidedTour from "@/components/guided/LifestyleGuidedTour";
// … other imports

export default function EmotionAIHub() {
  return (
    <div className="relative">
      <LifestyleGuidedTour />

      {/* Your existing tiles; add data-lifestyle tags so the tour can click them */}
      <div className="grid gap-4">
        <button
          data-lifestyle="craving"
          onClick={() => setLocation("/CravingCreator")}  // adjust route if needed
          className="btn btn-glass"
        >
          Craving Creator
        </button>

        <button
          data-lifestyle="fridge"
          onClick={() => setLocation("/fridge-rescue")}
          className="btn btn-glass"
        >
          Fridge Rescue
        </button>

        <button
          data-lifestyle="restaurants"
          onClick={() => setLocation("/restaurant-guide")}
          className="btn btn-glass"
        >
          Restaurant Guide
        </button>

        <button
          data-lifestyle="kids"
          onClick={() => setLocation("/HealthyKidsMeals")}
          className="btn btn-glass"
        >
          Healthy Kids Meals
        </button>

        <button
          data-lifestyle="alcohol"
          onClick={() => setLocation("/AlcoholHubLanding")}
          className="btn btn-glass"
        >
          Alcohol Hub
        </button>
      </div>
    </div>
  );
}
```

---

# 3) (Already Done) Builders share the same guided system

You’ve already integrated:

* **MealProgressCoach** (highlights next meal)
* **MealBuilderGuidedTour** (picker sequence)
* **DailyMealProgressBar** (fills as meals are saved)

Because every builder follows the same UI pattern and we use data attributes/events, these work **unchanged** for:

* Weekly Meal Board
* Diabetic Meal Builder
* GLP-1 Meal Builder
* Athlete/Competition Meal Board

Just ensure each page:

* Uses the `data-meal-id` & `data-role="create-ai-meal"` attributes
* Dispatches `meal:saved` when a meal is finalized

---

## What you’ll see now

* **Auth** is back. Users must sign up / log in.
* **Welcome page** appears after first login (your brand page). Press **Continue**.
* **WelcomeGate** then asks Coach vs Self.
* **Dashboard** opens; in Coach Mode the guided glow begins.
* **Biometrics** → green CTA → weight → save → **Planner**.
* **Planner** → “?” overlay explains hubs; buttons pulse.
* **Any Meal Board** → progress bar, next-meal highlight, picker tour.
* **Lifestyle hub** → “Start here” → overlay & pulsing tiles.

Everything core is functional; bells & whistles (confetti, sounds) are optional and can be added later without touching this backbone.

If you paste these changes in, your onboarding + guided system will be consistent across the entire app.
