Awesome — here’s a clean, drop-in **Next-Meal Progression Coach** that:

* Tracks which meals are completed for **today** (localStorage, auto-resets daily).
* Listens for a `meal:saved` event from your picker (you’ll add one line on Save).
* **Highlights the next meal card’s “Create AI Meal” button** automatically.
* Works across **Weekly Meal Board, Diabetic Hub, GLP-1 Hub**, etc.
* Only runs when **Coach Mode** is ON.

---

# 1) Create: `client/src/lib/mealProgress.ts`

```ts
// Simple per-day meal progression store

export type MealId =
  | "breakfast"
  | "lunch"
  | "dinner"
  | "snack1"
  | "snack2";

const ORDER: MealId[] = ["breakfast", "lunch", "dinner", "snack1", "snack2"];

const keyForToday = () => {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `mpm.mealProgress.${y}-${m}-${day}`;
};

export function getProgress(): Partial<Record<MealId, boolean>> {
  try {
    const raw = localStorage.getItem(keyForToday());
    return raw ? JSON.parse(raw) : {};
  } catch {
    return {};
  }
}

export function setCompleted(mealId: MealId) {
  const data = getProgress();
  data[mealId] = true;
  localStorage.setItem(keyForToday(), JSON.stringify(data));
}

export function resetToday() {
  localStorage.removeItem(keyForToday());
}

export function nextIncomplete(mealsPresent?: MealId[]): MealId | null {
  const data = getProgress();
  const list = mealsPresent && mealsPresent.length ? mealsPresent : ORDER;
  for (const id of list) {
    if (!data[id]) return id;
  }
  return null;
}
```

---

# 2) Create: `client/src/components/guided/MealProgressCoach.tsx`

```tsx
import { useEffect, useMemo, useState } from "react";
import { nextIncomplete, setCompleted, MealId } from "@/lib/mealProgress";

/**
 * MealProgressCoach
 * - Highlights the next incomplete meal card's "Create AI Meal" button.
 * - Listens for `meal:saved` events to mark completion and move on.
 * - Only runs if coachMode === "guided".
 *
 * Requirements on each meal card:
 *  - data-meal-id="breakfast" | "lunch" | "dinner" | "snack1" | "snack2"
 *  - A "Create AI Meal" trigger inside the card with
 *      data-role="create-ai-meal"
 *
 * Example markup (inside a meal card):
 *  <div className="meal-card" data-meal-id="breakfast">
 *    <button data-role="create-ai-meal" onClick={openPicker}>Create AI Meal</button>
 *  </div>
 */

const COACH_ON = () => localStorage.getItem("coachMode") === "guided";

export default function MealProgressCoach() {
  const [enabled, setEnabled] = useState(COACH_ON());
  const [focusId, setFocusId] = useState<MealId | null>(null);

  // Detect which meal cards are present on this board (in case some hubs differ)
  const presentMeals = useMemo<MealId[]>(() => {
    if (typeof document === "undefined") return [];
    const nodes = Array.from(document.querySelectorAll<HTMLElement>("[data-meal-id]"));
    const ids = nodes
      .map((n) => n.getAttribute("data-meal-id") as MealId | null)
      .filter((v): v is MealId => !!v);
    return ids;
  }, []);

  // Find next incomplete when mounted or when meals change
  useEffect(() => {
    if (!enabled) return;
    const next = nextIncomplete(presentMeals);
    setFocusId(next);
    highlight(next);
    return () => removeAllHighlights();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [enabled]);

  // Listen for meal saved events and advance
  useEffect(() => {
    if (!enabled) return;
    const onSaved = (e: Event) => {
      const detail = (e as CustomEvent).detail as { mealId?: MealId } | undefined;
      const id = detail?.mealId;
      if (!id) return;
      setCompleted(id);
      removeAllHighlights();
      const next = nextIncomplete(presentMeals);
      setFocusId(next);
      highlight(next);
    };
    window.addEventListener("meal:saved", onSaved as EventListener);
    return () => window.removeEventListener("meal:saved", onSaved as EventListener);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [enabled]);

  if (!enabled) return null;

  return null;
}

/** Utilities */

function highlight(mealId: MealId | null) {
  if (!mealId) return;
  const card = document.querySelector<HTMLElement>(`[data-meal-id="${mealId}"]`);
  if (!card) return;
  const btn = card.querySelector<HTMLElement>('[data-role="create-ai-meal"]');
  card.classList.add("coach-card-focus");
  if (btn) btn.classList.add("flash-green-strong");
}

function removeAllHighlights() {
  document.querySelectorAll(".coach-card-focus").forEach((el) => el.classList.remove("coach-card-focus"));
  document.querySelectorAll('[data-role="create-ai-meal"]').forEach((el) => el.classList.remove("flash-green-strong"));
}
```

---

# 3) Tiny CSS addition (optional, for card glow)

Add to your global CSS (you already have `flash-green-strong`):

```css
.coach-card-focus {
  outline: 2px solid rgba(16,185,129,0.55); /* emerald */
  outline-offset: 2px;
  border-radius: 1rem;
}
```

---

# 4) Hook up your Meal Board page(s)

In **WeeklyMealBoard.tsx** (and the other hubs’ boards), add:

```tsx
import MealProgressCoach from "@/components/guided/MealProgressCoach";

export default function WeeklyMealBoard() {
  return (
    <div className="relative">
      <MealProgressCoach />

      {/* Example meal cards */}
      <div className="grid gap-4">
        <div className="rounded-2xl p-4 bg-black/40" data-meal-id="breakfast">
          <h3 className="text-white font-semibold mb-2">Breakfast</h3>
          <button
            data-role="create-ai-meal"
            onClick={() => openPickerFor("breakfast")}
            className="btn btn-glass"
          >
            Create AI Meal
          </button>
        </div>

        <div className="rounded-2xl p-4 bg-black/40" data-meal-id="lunch">
          <h3 className="text-white font-semibold mb-2">Lunch</h3>
          <button
            data-role="create-ai-meal"
            onClick={() => openPickerFor("lunch")}
            className="btn btn-glass"
          >
            Create AI Meal
          </button>
        </div>

        <div className="rounded-2xl p-4 bg-black/40" data-meal-id="dinner">
          <h3 className="text-white font-semibold mb-2">Dinner</h3>
          <button
            data-role="create-ai-meal"
            onClick={() => openPickerFor("dinner")}
            className="btn btn-glass"
          >
            Create AI Meal
          </button>
        </div>
      </div>
    </div>
  );
}
```

(If you have snacks, add `data-meal-id="snack1"` / `"snack2"` as needed.)

---

# 5) Dispatch the “meal saved” event from your Picker

In **MealPickerDrawer.tsx** (or whichever picker component handles the finalization), when the user confirms the meal:

```tsx
// Assume you know the current mealId for which the picker was opened
function handleDone(mealId: "breakfast" | "lunch" | "dinner" | "snack1" | "snack2") {
  // ... your existing save logic

  // Dispatch the event so the coach can progress
  window.dispatchEvent(
    new CustomEvent("meal:saved", { detail: { mealId } })
  );

  closePicker();
}
```

Make sure your picker root already has the `id="meal-picker-drawer"` and toggles `"open"` (you added this in the previous step).

---

## How it feels in the app

1. User lands on a board → **Breakfast** card’s Create AI button pulses.
2. They build Breakfast and press Done → **Lunch** is now highlighted.
3. Repeat → **Dinner** gets highlighted.
4. Snacks get highlighted if present; otherwise progression stops.
5. Progress remembers **today only**; it resets automatically each day.

---

If you want me to wire this into your **Diabetic Hub** and **GLP-1 Hub** boards too, the same component works — just ensure those pages use the same `data-meal-id` and `data-role="create-ai-meal"` attributes and dispatch `meal:saved` on completion.
