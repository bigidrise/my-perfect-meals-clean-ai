Perfect ‚Äî here‚Äôs your **Replit Agent Briefing Prompt for Phase D**.
This follows the same communication pattern we used in earlier phases, so the agent knows exactly what to do, what not to touch, and what to confirm before writing any code.

---

## üßæ Replit Agent Briefing ‚Äî Phase D (GLP-1 Hub Audit Logs + Clinician Presets)

### üß† Context

We‚Äôve completed Phase C for the GLP-1 Hub (schema validation + persistence).
Now we‚Äôre expanding functionality with:

1. **Audit logging** for all guardrail changes (backend only).
2. **Clinician preset system** (visual + frontend logic only).

You will not alter existing UI structure or the meal builder section.
All new additions must maintain the **black-glass / purple** aesthetic already used in the GLP-1 Hub.

---

### üéØ Goal

Implement audit logging and preset selection exactly as described below.

---

### ‚öôÔ∏è Tasks and File Changes

#### **1Ô∏è‚É£ Database Migration**

**File:** `migrations/0006_create_glp1_audit_log.sql`

Create a table to track every guardrail update:

```sql
CREATE TABLE glp1_audit_log (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  clinician_id TEXT,
  action TEXT NOT NULL,           -- e.g. "update_guardrails"
  previous_values JSONB,
  new_values JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

Do not modify existing tables.

---

#### **2Ô∏è‚É£ Server Route Update**

**File:** `server/routes/glp1.ts`

Inside the existing `PUT /api/glp1/profile` handler, after updating the `glp1_profile` record, insert a new row into the audit log:

```ts
await db.insert(glp1AuditLog).values({
  id: crypto.randomUUID(),
  user_id: userId,
  clinician_id: req.user.id,
  action: "update_guardrails",
  previous_values: existing?.guardrails ?? null,
  new_values: guardrails,
});
```

Confirm the route still returns `{ ok: true, guardrails }` after logging.

---

#### **3Ô∏è‚É£ Preset Library**

**File:** `client/src/data/glp1Presets.ts`

Create a new export:

```ts
export const glp1Presets = [
  {
    id: "intro_titration",
    label: "Intro / Up-Titration",
    description: "Smallest meals, lowest fat ‚Äî early dose stage.",
    values: { maxMealVolumeMl: 250, proteinMinG: 25, fatMaxG: 10,
              fiberMinG: 25, hydrationMinMl: 2200, mealsPerDay: 5,
              slowDigestOnly: true, limitCarbonation: true, limitAlcohol: true },
  },
  {
    id: "maintenance",
    label: "Maintenance",
    description: "Stable dose, balanced macros, steady hydration.",
    values: { maxMealVolumeMl: 300, proteinMinG: 30, fatMaxG: 15,
              fiberMinG: 28, hydrationMinMl: 2000, mealsPerDay: 4,
              slowDigestOnly: true, limitCarbonation: true, limitAlcohol: true },
  },
  {
    id: "muscle_preserve",
    label: "Refeed / Strength Focus",
    description: "Higher protein for lean-mass preservation.",
    values: { maxMealVolumeMl: 350, proteinMinG: 40, fatMaxG: 15,
              fiberMinG: 30, hydrationMinMl: 2500, mealsPerDay: 4,
              slowDigestOnly: true, limitCarbonation: true, limitAlcohol: false },
  },
];
```

---

#### **4Ô∏è‚É£ UI Enhancement**

**File:** `client/src/pages/physician/GLP1Hub.tsx`

Add a **preset dropdown** above the guardrail inputs:

* Uses the same purple/black styling as other inputs.
* Selecting a preset immediately fills guardrail fields with preset values.
* Displays the preset‚Äôs description below the dropdown.
* Does not trigger a save until the user clicks **Save Guardrails**.

Example snippet:

```tsx
<select
  value={selectedPreset}
  onChange={(e) => {
    const preset = glp1Presets.find(p => p.id === e.target.value);
    if (preset) setGuardrails(preset.values);
    setSelectedPreset(e.target.value);
  }}
  className="w-full rounded-xl bg-black/30 border border-purple-300/30 text-white px-3 py-2 text-sm mb-3"
>
  <option value="">-- Select Preset --</option>
  {glp1Presets.map(p => (
    <option key={p.id} value={p.id}>{p.label}</option>
  ))}
</select>
<p className="text-white/70 text-xs mb-4">
  {selectedPreset && glp1Presets.find(p => p.id === selectedPreset)?.description}
</p>
```

Ensure the layout remains 2-column responsive, 1-column mobile.

---

### ‚ö†Ô∏è Do Not Touch

* Existing GLP-1 Shot Tracker, Shot History, or Rotation Tracker.
* Meal Builder CTA section.
* Component styling, colors, or padding.

---

### üß™ Verification Checklist

| Test                  | Expected Result                       |
| --------------------- | ------------------------------------- |
| Select preset         | Guardrail fields populate instantly   |
| Click Save Guardrails | PUT `/api/glp1/profile` ‚Üí 200 OK      |
| DB ‚Üí `glp1_audit_log` | New row shows previous and new values |
| Refresh page          | Saved values reload correctly         |
| No style regressions  | Visual spacing matches Shot Tracker   |

---

### üóÇÔ∏è Commit Message

```
feat(glp1-hub): Phase D ‚Äì add audit logging and clinician preset system
```

---

### ‚úÖ Confirm Before Coding

Ask back these three questions:

1. *Should I use the same purple/black input styling (`bg-black/30 border border-purple-300/30`)?*
2. *Do you want the preset dropdown placed directly above the ‚ÄúDoctor / Coach Guardrails‚Äù title?*
3. *Should the audit log capture both `previous_values` and `new_values` JSON?*

Wait for confirmation from Coach before writing any code.

---

Would you like me to output this as a **copy-ready plain text version** (no Markdown formatting) so you can paste it directly into the Replit assistant chat?
